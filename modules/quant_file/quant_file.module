<?php

/**
 * @file
 * Module functions for quant_file.
 */

/**
 * Implements hook_help().
 */
function quant_file_help($section) {
  switch ($section) {
    case 'admin/help#quant_file':
      return quant_help('admin/help#quant');
  }
}

/**
 * Implements hook_file_insert().
 */
function quant_file_file_insert($file) {
  $entity_info = array(
    'entity' => $file,
    'type' => 'file',
    'op' => 'insert',
    'original' => NULL,
  );

  if (!empty($file->op)) {
    drupal_register_shutdown_function('_quant_shutdown', $entity_info);
  }
}

/**
 * Implements hook_file_update().
 */
function quant_file_file_update($file) {

  $original = isset($file->original) ? $file->original : NULL;
  $entity_info = array(
    'entity' => $file,
    'type' => 'file',
    'op' => 'insert',
    'original' => $original,
  );

  if (!empty($file->op)) {
    drupal_register_shutdown_function('_quant_shutdown', $entity_info);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function quant_file_form_quant_seed_settings_alter(&$form, $form_state) {
  $form['quant_seed_files'] = array(
    '#type' => 'checkbox',
    '#title' => t('Export file pages'),
    '#default_value' => variable_get('quant_seed_files', FALSE),
  );
}

/**
 * Implements hook_quant_seed_queue().
 */
function quant_file_quant_seed_queue() {
  if (!variable_get('quant_seed_files', FALSE)) {
    return;
  }

  $queue = quant_get_queue();

  $files = db_select('file_managed', 'f')
    ->fields('f', array('fid', 'status'))
    ->condition('status', 1)
    ->execute();

  while ($file = $files->fetchAssoc()) {
    list($url, $context) = _quant_prepare_entity('file', $file['fid']);
    if (empty($url)) {
      quant_log('No URL found for file !fid',
        array(
          '!fid' => $file['fid'],
        ),
        WATCHDOG_WARNING);
      continue;
    }
    quant_log('Quant: Adding file page [!url] to the list.', array('!url' => $url));
    $item = array(
      'quant_seed',
      array($url, $context),
    );
    $queue->createItem($item);
  }
}

/**
 * Implements hook_quant_meta_TYPE_alter().
 */
function quant_file_quant_meta_file_alter(&$meta, $context) {
  $meta['published'] = boolval($context['entity']->status);
  $meta['content_timestamp'] = $context['entity']->timestamp;
  $meta['info'] = [
    'author_name' => $context['entity']->uid,
  ];
}
